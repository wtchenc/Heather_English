<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>單字小達人 - Vocabulary App</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Custom Styles */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .preserve-3d { transform-style: preserve-3d; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        @keyframes bounce-in {
          0% { transform: scale(0.9); opacity: 0; }
          50% { transform: scale(1.05); opacity: 1; }
          100% { transform: scale(1); }
        }
        .animate-bounce-in { animation: bounce-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Custom Input Style for Spelling */
        .spelling-input:focus {
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // Icons Components
        const Icons = {
            Volume2: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path></svg>,
            RotateCw: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path></svg>,
            BookOpen: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>,
            Brain: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"></path><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"></path></svg>,
            List: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>,
            ChevronRight: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="9 18 15 12 9 6"></polyline></svg>,
            ChevronLeft: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="15 18 9 12 15 6"></polyline></svg>,
            CheckCircle: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>,
            Settings: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>,
            Filter: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>,
            LayoutGrid: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>,
            XCircle: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>,
            Keyboard: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="2" y="4" width="20" height="16" rx="2" ry="2"></rect><line x1="6" y1="8" x2="6" y2="8"></line><line x1="10" y1="8" x2="10" y2="8"></line><line x1="14" y1="8" x2="14" y2="8"></line><line x1="18" y1="8" x2="18" y2="8"></line><line x1="6" y1="12" x2="6" y2="12"></line><line x1="10" y1="12" x2="10" y2="12"></line><line x1="14" y1="12" x2="14" y2="12"></line><line x1="18" y1="12" x2="18" y2="12"></line><line x1="6" y1="16" x2="18" y2="16"></line></svg>,
            HelpCircle: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>,
            RefreshCw: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>,
            Trophy: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path><path d="M4 22h16"></path><path d="M10 14.66V17"></path><path d="M14 14.66V17"></path><path d="M12 2v20"></path><path d="M2 17h20"></path></svg>
        };

        // Full Vocabulary Data with Part of Speech (PoS)
        const allVocabularyData = [
          // --- Unit 3 ---
          // Lesson 1
          { id: 30101, unit: 3, lesson: 1, en: "food", zh: "食物", pos: "n. 名詞" },
          { id: 30102, unit: 3, lesson: 1, en: "soup", zh: "湯", pos: "n. 名詞" },
          { id: 30103, unit: 3, lesson: 1, en: "salad", zh: "沙拉", pos: "n. 名詞" },
          { id: 30104, unit: 3, lesson: 1, en: "spaghetti", zh: "義大利麵", pos: "n. 名詞" },
          { id: 30105, unit: 3, lesson: 1, en: "french fries", zh: "薯條", pos: "n. 名詞" },
          { id: 30106, unit: 3, lesson: 1, en: "steak", zh: "牛排", pos: "n. 名詞" },
          { id: 30107, unit: 3, lesson: 1, en: "eggs", zh: "蛋", pos: "n. 名詞" },
          { id: 30108, unit: 3, lesson: 1, en: "worm", zh: "蟲", pos: "n. 名詞" },
          { id: 30109, unit: 3, lesson: 1, en: "butterfly", zh: "蝴蝶", pos: "n. 名詞" },
          { id: 30110, unit: 3, lesson: 1, en: "beetle", zh: "甲蟲", pos: "n. 名詞" },
          // Lesson 2
          { id: 30201, unit: 3, lesson: 2, en: "fruit", zh: "水果", pos: "n. 名詞" },
          { id: 30202, unit: 3, lesson: 2, en: "apple", zh: "蘋果", pos: "n. 名詞" },
          { id: 30203, unit: 3, lesson: 2, en: "banana", zh: "香蕉", pos: "n. 名詞" },
          { id: 30204, unit: 3, lesson: 2, en: "orange", zh: "橘子", pos: "n. 名詞" },
          { id: 30205, unit: 3, lesson: 2, en: "peach", zh: "桃子", pos: "n. 名詞" },
          { id: 30206, unit: 3, lesson: 2, en: "ant", zh: "螞蟻", pos: "n. 名詞" },
          { id: 30207, unit: 3, lesson: 2, en: "this", zh: "這", pos: "pron. 代名詞" },
          { id: 30208, unit: 3, lesson: 2, en: "mother", zh: "媽媽", pos: "n. 名詞" },
          { id: 30209, unit: 3, lesson: 2, en: "three", zh: "三", pos: "num. 數詞" },
          { id: 30210, unit: 3, lesson: 2, en: "duck", zh: "鴨子", pos: "n. 名詞" },
          // Lesson 3
          { id: 30301, unit: 3, lesson: 3, en: "please", zh: "請", pos: "int. 感嘆詞" },
          { id: 30302, unit: 3, lesson: 3, en: "polite", zh: "有禮貌的", pos: "adj. 形容詞" },
          { id: 30303, unit: 3, lesson: 3, en: "queen", zh: "女王", pos: "n. 名詞" },
          { id: 30304, unit: 3, lesson: 3, en: "bank", zh: "銀行", pos: "n. 名詞" },
          { id: 30305, unit: 3, lesson: 3, en: "wind", zh: "風", pos: "n. 名詞" },
          { id: 30306, unit: 3, lesson: 3, en: "tent", zh: "帳篷", pos: "n. 名詞" },
          { id: 30307, unit: 3, lesson: 3, en: "paint", zh: "油漆/繪畫", pos: "n./v. 名詞/動詞" },
          { id: 30308, unit: 3, lesson: 3, en: "belt", zh: "皮帶", pos: "n. 名詞" },
          { id: 30309, unit: 3, lesson: 3, en: "lamp", zh: "燈", pos: "n. 名詞" },
          { id: 30310, unit: 3, lesson: 3, en: "camp", zh: "露營", pos: "v. 動詞" },
          // Lesson 4
          { id: 30401, unit: 3, lesson: 4, en: "dairy product", zh: "乳製品", pos: "n. 名詞" },
          { id: 30402, unit: 3, lesson: 4, en: "milk", zh: "牛奶", pos: "n. 名詞" },
          { id: 30403, unit: 3, lesson: 4, en: "yogurt", zh: "優格", pos: "n. 名詞" },
          { id: 30404, unit: 3, lesson: 4, en: "cheese", zh: "起司", pos: "n. 名詞" },
          { id: 30405, unit: 3, lesson: 4, en: "butter", zh: "奶油", pos: "n. 名詞" },
          { id: 30406, unit: 3, lesson: 4, en: "forest", zh: "森林", pos: "n. 名詞" },
          { id: 30407, unit: 3, lesson: 4, en: "grass", zh: "草", pos: "n. 名詞" },
          { id: 30408, unit: 3, lesson: 4, en: "garden", zh: "花園", pos: "n. 名詞" },
          { id: 30409, unit: 3, lesson: 4, en: "cactus", zh: "仙人掌", pos: "n. 名詞" },
          { id: 30410, unit: 3, lesson: 4, en: "long", zh: "長的", pos: "adj. 形容詞" },

          // --- Unit 4 ---
          // Lesson 1
          { id: 40101, unit: 4, lesson: 1, en: "clothes", zh: "衣服", pos: "n. 名詞" },
          { id: 40102, unit: 4, lesson: 1, en: "shirt", zh: "襯衫", pos: "n. 名詞" },
          { id: 40103, unit: 4, lesson: 1, en: "dress", zh: "洋裝", pos: "n. 名詞" },
          { id: 40104, unit: 4, lesson: 1, en: "skirt", zh: "裙子", pos: "n. 名詞" },
          { id: 40105, unit: 4, lesson: 1, en: "pants", zh: "褲子", pos: "n. 名詞" },
          { id: 40106, unit: 4, lesson: 1, en: "socks", zh: "襪子", pos: "n. 名詞" },
          { id: 40107, unit: 4, lesson: 1, en: "shoes", zh: "鞋子", pos: "n. 名詞" },
          { id: 40108, unit: 4, lesson: 1, en: "wear", zh: "穿", pos: "v. 動詞" },
          { id: 40109, unit: 4, lesson: 1, en: "gift", zh: "禮物", pos: "n. 名詞" },
          { id: 40110, unit: 4, lesson: 1, en: "roof", zh: "屋頂", pos: "n. 名詞" },
          // Lesson 2
          { id: 40201, unit: 4, lesson: 2, en: "cap", zh: "棒球帽", pos: "n. 名詞" },
          { id: 40202, unit: 4, lesson: 2, en: "T-shirt", zh: "T恤", pos: "n. 名詞" },
          { id: 40203, unit: 4, lesson: 2, en: "shorts", zh: "短褲", pos: "n. 名詞" },
          { id: 40204, unit: 4, lesson: 2, en: "sneakers", zh: "運動鞋", pos: "n. 名詞" },
          { id: 40205, unit: 4, lesson: 2, en: "desk", zh: "書桌", pos: "n. 名詞" },
          { id: 40206, unit: 4, lesson: 2, en: "puzzle", zh: "拼圖", pos: "n. 名詞" },
          { id: 40207, unit: 4, lesson: 2, en: "skunk", zh: "臭鼬", pos: "n. 名詞" },
          { id: 40208, unit: 4, lesson: 2, en: "school", zh: "學校", pos: "n. 名詞" },
          { id: 40209, unit: 4, lesson: 2, en: "spray", zh: "噴霧", pos: "v./n. 動詞/名詞" },
          { id: 40210, unit: 4, lesson: 2, en: "string", zh: "細繩", pos: "n. 名詞" },
          // Lesson 3
          { id: 40301, unit: 4, lesson: 3, en: "find", zh: "找", pos: "v. 動詞" },
          { id: 40302, unit: 4, lesson: 3, en: "phone number", zh: "電話號碼", pos: "n. 名詞" },
          { id: 40303, unit: 4, lesson: 3, en: "where", zh: "哪裡", pos: "adv. 副詞" },
          { id: 40304, unit: 4, lesson: 3, en: "what", zh: "什麼", pos: "pron. 代名詞" },
          { id: 40305, unit: 4, lesson: 3, en: "rice", zh: "米飯", pos: "n. 名詞" },
          { id: 40306, unit: 4, lesson: 3, en: "city", zh: "城市", pos: "n. 名詞" },
          { id: 40307, unit: 4, lesson: 3, en: "ice cream", zh: "冰淇淋", pos: "n. 名詞" },
          { id: 40308, unit: 4, lesson: 3, en: "giraffe", zh: "長頸鹿", pos: "n. 名詞" },
          { id: 40309, unit: 4, lesson: 3, en: "orange", zh: "橘子", pos: "n. 名詞" },
          { id: 40310, unit: 4, lesson: 3, en: "giant", zh: "巨人", pos: "n. 名詞" },
          // Lesson 4
          { id: 40401, unit: 4, lesson: 4, en: "hat", zh: "帽子(有邊的)", pos: "n. 名詞" },
          { id: 40402, unit: 4, lesson: 4, en: "coat", zh: "外套", pos: "n. 名詞" },
          { id: 40403, unit: 4, lesson: 4, en: "sweater", zh: "毛衣", pos: "n. 名詞" },
          { id: 40404, unit: 4, lesson: 4, en: "boots", zh: "靴子", pos: "n. 名詞" },
          { id: 40405, unit: 4, lesson: 4, en: "second", zh: "第二", pos: "num. 數詞" },
          { id: 40406, unit: 4, lesson: 4, en: "third", zh: "第三", pos: "num. 數詞" },
          { id: 40407, unit: 4, lesson: 4, en: "rose", zh: "玫瑰", pos: "n. 名詞" },
          { id: 40408, unit: 4, lesson: 4, en: "jeans", zh: "牛仔褲", pos: "n. 名詞" },
          { id: 40409, unit: 4, lesson: 4, en: "cheese", zh: "起司", pos: "n. 名詞" },
          { id: 40410, unit: 4, lesson: 4, en: "legs", zh: "腿", pos: "n. 名詞" },
        ];

        // Shuffle utility
        const shuffleArray = (array) => {
          const newArray = [...array];
          for (let i = newArray.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
          }
          return newArray;
        };

        const App = () => {
          const [activeTab, setActiveTab] = useState('cards');
          const [currentCardIndex, setCurrentCardIndex] = useState(0);
          const [isFlipped, setIsFlipped] = useState(false);
          
          // Selection State
          const [selectedUnit, setSelectedUnit] = useState('all');
          const [selectedLesson, setSelectedLesson] = useState('all');

          // Quiz State - Now Round Based
          const [quizSubMode, setQuizSubMode] = useState('choice'); // 'choice' or 'spelling'
          const [quizList, setQuizList] = useState([]);
          const [quizIndex, setQuizIndex] = useState(0);
          const [quizPhase, setQuizPhase] = useState('setup'); // 'setup', 'playing', 'finished'
          
          const [quizQuestion, setQuizQuestion] = useState(null);
          const [quizOptions, setQuizOptions] = useState([]);
          const [quizScore, setQuizScore] = useState(0);
          const [showResult, setShowResult] = useState(false);
          const [lastAnswerCorrect, setLastAnswerCorrect] = useState(null);

          // Spelling Quiz State
          const [spellingInput, setSpellingInput] = useState('');
          const [showSpellingAnswer, setShowSpellingAnswer] = useState(false);
          const inputRef = useRef(null);

          // Filter Logic
          const filteredData = useMemo(() => {
            return allVocabularyData.filter(item => {
              const unitMatch = selectedUnit === 'all' || item.unit === parseInt(selectedUnit);
              const lessonMatch = selectedLesson === 'all' || item.lesson === parseInt(selectedLesson);
              return unitMatch && lessonMatch;
            });
          }, [selectedUnit, selectedLesson]);

          // Reset Flashcards when filter changes
          useEffect(() => {
            setCurrentCardIndex(0);
            setIsFlipped(false);
          }, [filteredData.length]);

          // Initialize Quiz when entering quiz tab or filter changes
          useEffect(() => {
            if (activeTab === 'quiz') {
               startQuizRound();
            }
          }, [filteredData.length, activeTab]);

          const startQuizRound = useCallback(() => {
              const shuffled = shuffleArray(filteredData);
              setQuizList(shuffled);
              setQuizIndex(0);
              setQuizScore(0);
              setQuizPhase(shuffled.length > 0 ? 'playing' : 'finished');
              if (shuffled.length > 0) {
                  loadQuestion(shuffled[0], 0);
              }
          }, [filteredData]);

          const loadQuestion = (word, index) => {
              setQuizQuestion(word);
              setQuizIndex(index);
              setShowResult(false);
              setLastAnswerCorrect(null);
              setSpellingInput('');
              setShowSpellingAnswer(false);
              
              // Generate distractors for choice mode
              let options = [word];
              const pool = filteredData.length >= 4 ? filteredData : allVocabularyData;
              // Try to get unique distractors
              const maxDistractors = Math.min(3, pool.length - 1);
              let attempts = 0;
              while (options.length < 1 + maxDistractors && attempts < 50) {
                  const randomDistractor = pool[Math.floor(Math.random() * pool.length)];
                  if (!options.find(o => o.id === randomDistractor.id)) {
                      options.push(randomDistractor);
                  }
                  attempts++;
              }
              setQuizOptions(shuffleArray(options));
          };

          const handleNextQuestion = () => {
              const nextIdx = quizIndex + 1;
              if (nextIdx < quizList.length) {
                  loadQuestion(quizList[nextIdx], nextIdx);
              } else {
                  setQuizPhase('finished');
              }
          };

          // Speech Synthesis
          const speak = (text) => {
            if ('speechSynthesis' in window) {
              window.speechSynthesis.cancel();
              const utterance = new SpeechSynthesisUtterance(text);
              utterance.lang = 'en-US';
              
              // Attempt to set a specific US English voice
              const voices = window.speechSynthesis.getVoices();
              // Prioritize Google US English or Microsoft David/Zira if available, otherwise any en-US
              const usVoice = voices.find(v => v.lang === 'en-US' && (v.name.includes('Google') || v.name.includes('Microsoft'))) || 
                              voices.find(v => v.lang === 'en-US');
              
              if (usVoice) {
                  utterance.voice = usVoice;
              }

              utterance.rate = 0.8;
              window.speechSynthesis.speak(utterance);
            }
          };

          // Card Navigation
          const nextCard = () => {
            setIsFlipped(false);
            setTimeout(() => {
              setCurrentCardIndex((prev) => (prev + 1) % filteredData.length);
            }, 150);
          };

          const prevCard = () => {
            setIsFlipped(false);
            setTimeout(() => {
              setCurrentCardIndex((prev) => (prev - 1 + filteredData.length) % filteredData.length);
            }, 150);
          };

          const handleQuizAnswer = (selectedWord) => {
            if (showResult) return;
            
            const isCorrect = selectedWord.id === quizQuestion.id;
            setLastAnswerCorrect(isCorrect);
            setShowResult(true);
            
            if (isCorrect) {
              setQuizScore(prev => prev + 1);
              speak("Correct! " + quizQuestion.en);
            } else {
              speak("Try again");
            }
          };
          
          const handleSpellingSubmit = (e) => {
              e.preventDefault();
              if (showResult) return; 

              const userInput = spellingInput.trim().toLowerCase();
              const answer = quizQuestion.en.trim().toLowerCase();
              
              const isCorrect = userInput === answer;
              setLastAnswerCorrect(isCorrect);
              
              if (isCorrect) {
                  setShowResult(true);
                  setQuizScore(prev => prev + 1);
                  speak("Correct! " + quizQuestion.en);
              } else {
                   setShowResult(true); 
                   speak("Incorrect. The answer is " + quizQuestion.en);
              }
          };

          // Navigation Items
          const NavItems = ({ mobile = false }) => {
            const items = [
              { id: 'cards', icon: Icons.RotateCw, label: '單字卡' },
              { id: 'quiz', icon: Icons.Brain, label: '測驗' },
              { id: 'list', icon: Icons.List, label: '列表' }
            ];

            if (mobile) {
              return (
                <div className="flex justify-around p-2 w-full">
                  {items.map(item => (
                    <button 
                      key={item.id}
                      onClick={() => setActiveTab(item.id)}
                      className={`flex flex-col items-center p-2 rounded-lg w-20 transition-colors ${activeTab === item.id ? 'text-indigo-600 bg-indigo-50' : 'text-slate-400 hover:text-slate-600'}`}
                    >
                      <item.icon className="w-6 h-6 mb-1" />
                      <span className="text-xs font-medium">{item.label}</span>
                    </button>
                  ))}
                </div>
              );
            }

            return (
              <div className="flex gap-4">
                {items.map(item => (
                  <button 
                    key={item.id}
                    onClick={() => setActiveTab(item.id)}
                    className={`flex items-center gap-2 px-4 py-2 rounded-lg font-medium transition-colors ${activeTab === item.id ? 'bg-indigo-500 text-white shadow-md' : 'text-indigo-100 hover:bg-indigo-500/50'}`}
                  >
                    <item.icon className="w-5 h-5" />
                    <span>{item.label}</span>
                  </button>
                ))}
              </div>
            );
          };

          const FilterControls = () => (
            <div className="flex gap-2 text-sm justify-center md:justify-end overflow-x-auto no-scrollbar">
              <select 
                value={selectedUnit} 
                onChange={(e) => { setSelectedUnit(e.target.value); setSelectedLesson('all'); }}
                className="bg-indigo-600 md:bg-white/10 text-white border border-indigo-500 md:border-white/20 rounded px-3 py-1.5 outline-none cursor-pointer hover:bg-indigo-500 transition-colors"
              >
                <option value="all">所有單元 (All Units)</option>
                <option value="3">Unit 3</option>
                <option value="4">Unit 4</option>
              </select>

              <select 
                value={selectedLesson} 
                onChange={(e) => setSelectedLesson(e.target.value)}
                className="bg-indigo-600 md:bg-white/10 text-white border border-indigo-500 md:border-white/20 rounded px-3 py-1.5 outline-none cursor-pointer hover:bg-indigo-500 transition-colors"
              >
                <option value="all">所有課程 (All Lessons)</option>
                <option value="1">Lesson 1</option>
                <option value="2">Lesson 2</option>
                <option value="3">Lesson 3</option>
                <option value="4">Lesson 4</option>
              </select>
            </div>
          );

          return (
            <div className="min-h-screen bg-slate-50 font-sans text-slate-800 flex flex-col">
              {/* Header - Responsive */}
              <header className="bg-indigo-600 text-white shadow-lg sticky top-0 z-20">
                <div className="max-w-6xl mx-auto p-4">
                  <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    
                    {/* Logo & Desktop Nav */}
                    <div className="flex items-center justify-between">
                      <h1 className="text-xl md:text-2xl font-bold flex items-center gap-2">
                        <Icons.BookOpen className="w-6 h-6 md:w-8 md:h-8" />
                        單字小達人
                      </h1>
                      {/* Desktop Nav (Visible only on md+) */}
                      <div className="hidden md:block ml-8">
                        <NavItems />
                      </div>
                      
                      {/* Mobile count badge */}
                      <div className="md:hidden text-xs bg-indigo-500 px-2 py-1 rounded-full flex items-center gap-1">
                        <Icons.Settings className="w-3 h-3" />
                        {filteredData.length} 字
                      </div>
                    </div>

                    {/* Filter Controls & Desktop Stats */}
                    <div className="flex items-center justify-between md:gap-4">
                       <div className="hidden md:flex text-sm bg-white/10 px-3 py-1.5 rounded-full items-center gap-2">
                        <Icons.LayoutGrid className="w-4 h-4" />
                        {filteredData.length} Words Loaded
                      </div>
                      <FilterControls />
                    </div>
                  </div>
                </div>
              </header>

              {/* Main Content Area */}
              <main className="flex-1 max-w-6xl mx-auto w-full p-4 pb-24 md:pb-8 overflow-y-auto">
                
                {/* Empty State */}
                {filteredData.length === 0 && (
                  <div className="text-center py-20 text-slate-400 bg-white rounded-3xl shadow-sm border border-slate-100 m-4">
                    <Icons.Filter className="w-16 h-16 mx-auto mb-4 text-slate-200" />
                    <p className="text-xl font-medium text-slate-500">沒有找到符合條件的單字</p>
                    <button onClick={() => {setSelectedUnit('all'); setSelectedLesson('all')}} className="mt-4 px-6 py-2 bg-indigo-50 text-indigo-600 rounded-full font-medium hover:bg-indigo-100 transition-colors">
                      重置所有篩選
                    </button>
                  </div>
                )}

                {/* Flashcard Mode */}
                {activeTab === 'cards' && filteredData.length > 0 && (
                  <div className="flex flex-col min-h-[60vh] md:min-h-[70vh] justify-center items-center max-w-2xl mx-auto">
                     {/* Unit/Lesson Badge */}
                     <div className="mb-6 text-xs md:text-sm font-bold text-slate-400 uppercase tracking-widest bg-slate-200 px-4 py-1.5 rounded-full">
                        Unit {filteredData[currentCardIndex].unit} — Lesson {filteredData[currentCardIndex].lesson}
                     </div>

                    <div className="relative w-full max-w-xs md:max-w-md aspect-[3/4] md:aspect-[4/3] perspective-1000 group cursor-pointer" onClick={() => setIsFlipped(!isFlipped)}>
                      <div 
                        className={`relative w-full h-full duration-500 preserve-3d transition-all`}
                        style={{ transform: isFlipped ? 'rotateY(180deg)' : 'rotateY(0deg)' }}
                      >
                        
                        {/* Front of Card - ENGLISH ONLY */}
                        <div 
                           className="absolute w-full h-full backface-hidden bg-white rounded-3xl shadow-xl hover:shadow-2xl transition-shadow flex flex-col items-center justify-center border-2 border-indigo-100 p-8 md:p-12"
                           style={{ zIndex: isFlipped ? 0 : 10 }}
                        >
                          <div className="text-sm md:text-base text-indigo-400 font-bold uppercase tracking-wider mb-6">English</div>
                          <h2 className="text-5xl md:text-7xl font-bold text-slate-800 text-center mb-8 break-words w-full leading-tight select-none">
                            {filteredData[currentCardIndex].en}
                          </h2>
                          <button 
                            onClick={(e) => { e.stopPropagation(); speak(filteredData[currentCardIndex].en); }}
                            className="p-4 md:p-6 bg-indigo-50 rounded-full text-indigo-600 hover:bg-indigo-100 hover:scale-110 active:scale-95 transition-all shadow-sm"
                            title="Listen"
                          >
                            <Icons.Volume2 className="w-8 h-8 md:w-10 md:h-10" />
                          </button>
                          <p className="absolute bottom-8 text-slate-400 text-sm md:text-base animate-pulse font-medium">點擊卡片翻面</p>
                        </div>

                        {/* Back of Card - CHINESE + ENGLISH + PoS */}
                        <div 
                           className="absolute w-full h-full backface-hidden rotate-y-180 bg-gradient-to-br from-indigo-600 to-violet-700 rounded-3xl shadow-xl flex flex-col items-center justify-center text-white p-8 md:p-12"
                           style={{ transform: 'rotateY(180deg)', zIndex: isFlipped ? 10 : 0 }}
                        >
                          <div className="text-sm md:text-base text-indigo-200 font-bold uppercase tracking-wider mb-6">中文</div>
                          <h2 className="text-5xl md:text-7xl font-bold text-center mb-8 select-none">{filteredData[currentCardIndex].zh}</h2>
                          <div className="text-2xl text-indigo-200 font-medium mb-8">{filteredData[currentCardIndex].en}</div>
                          
                          {/* Part of Speech Section */}
                          <div className="mt-4 pt-8 border-t border-white/20 w-full text-center">
                             <span className="inline-block bg-white/20 px-4 py-2 rounded-lg text-lg md:text-xl font-medium text-indigo-50 backdrop-blur-sm">
                               {filteredData[currentCardIndex].pos}
                             </span>
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* Controls */}
                    <div className="flex justify-between items-center w-full max-w-xs md:max-w-md mt-8 px-2 md:px-0">
                      <button onClick={prevCard} className="p-4 md:p-6 bg-white rounded-full shadow-lg text-indigo-600 hover:bg-indigo-50 hover:text-indigo-700 hover:-translate-x-1 active:scale-95 transition-all border border-indigo-50">
                        <Icons.ChevronLeft className="w-8 h-8 md:w-8 md:h-8" />
                      </button>
                      <div className="text-slate-500 font-medium bg-white px-6 py-3 rounded-full shadow-md border border-slate-100 min-w-[100px] text-center text-lg md:text-xl select-none">
                        <span className="text-indigo-600 font-bold">{currentCardIndex + 1}</span> 
                        <span className="mx-2 text-slate-300">/</span> 
                        {filteredData.length}
                      </div>
                      <button onClick={nextCard} className="p-4 md:p-6 bg-white rounded-full shadow-lg text-indigo-600 hover:bg-indigo-50 hover:text-indigo-700 hover:translate-x-1 active:scale-95 transition-all border border-indigo-50">
                        <Icons.ChevronRight className="w-8 h-8 md:w-8 md:h-8" />
                      </button>
                    </div>
                    
                    <div className="mt-8 text-center text-slate-400 text-sm md:hidden select-none">
                      左右滑動切換 • 點擊翻面
                    </div>
                  </div>
                )}

                {/* Quiz Mode (Round Based) */}
                {activeTab === 'quiz' && filteredData.length > 0 && (
                  <div className="flex flex-col py-4 max-w-3xl mx-auto min-h-[60vh]">
                    
                    {quizPhase === 'finished' ? (
                       /* Finished Screen */
                       <div className="bg-white rounded-3xl shadow-xl p-10 text-center animate-bounce-in flex flex-col items-center justify-center h-full min-h-[400px]">
                          <div className="w-24 h-24 bg-yellow-100 text-yellow-500 rounded-full flex items-center justify-center mb-6">
                             <Icons.Trophy className="w-12 h-12" />
                          </div>
                          <h2 className="text-4xl font-bold text-slate-800 mb-2">測驗完成！</h2>
                          <p className="text-slate-500 mb-8">Great job on finishing the quiz.</p>
                          
                          <div className="flex items-end gap-2 mb-10">
                             <span className="text-6xl font-bold text-indigo-600">{quizScore}</span>
                             <span className="text-2xl text-slate-400 mb-2">/ {quizList.length}</span>
                          </div>
                          
                          <button 
                             onClick={startQuizRound}
                             className="w-full max-w-xs px-8 py-4 bg-indigo-600 text-white rounded-2xl font-bold text-lg shadow-lg hover:bg-indigo-700 hover:shadow-xl hover:-translate-y-1 active:scale-95 transition-all flex items-center justify-center gap-2"
                          >
                             <Icons.RefreshCw className="w-6 h-6" /> 重新測驗
                          </button>
                       </div>
                    ) : (
                      /* Playing Screen */
                      <>
                        {/* Mode Toggle Switch */}
                        <div className="flex justify-center mb-6">
                            <div className="bg-slate-200 p-1 rounded-xl flex gap-1">
                                <button 
                                    onClick={() => setQuizSubMode('choice')}
                                    className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${quizSubMode === 'choice' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                                >
                                    選擇題 (Multiple Choice)
                                </button>
                                <button 
                                    onClick={() => setQuizSubMode('spelling')}
                                    className={`px-4 py-2 rounded-lg text-sm font-bold transition-all flex items-center gap-2 ${quizSubMode === 'spelling' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                                >
                                    <Icons.Keyboard className="w-4 h-4" />
                                    聽音拼字 (Spelling)
                                </button>
                            </div>
                        </div>

                        {quizQuestion && (
                        <div className="bg-white rounded-3xl shadow-xl p-8 mb-8 text-center border-b-8 border-indigo-50 relative overflow-hidden">
                           <div className="absolute top-0 left-0 w-full h-2 bg-indigo-100">
                              <div className="h-full bg-indigo-500 transition-all duration-500" style={{width: `${((quizIndex) / quizList.length) * 100}%`}}></div>
                           </div>
                          <div className="flex justify-between items-center mb-6 text-sm font-medium text-slate-400 uppercase tracking-wider">
                            <div className="flex flex-col items-start">
                               <span className="text-xs">Score</span>
                               <span className="text-2xl text-indigo-600 font-bold">{quizScore}</span>
                            </div>
                            
                            {/* Progress Section - Corrected Logic */}
                            <div className="flex flex-col items-center">
                               <span className="text-xs">Progress</span>
                               <span className="text-xl text-slate-700 font-bold">
                                 {quizIndex + 1} <span className="text-slate-400 text-base font-normal">/ {quizList.length}</span>
                               </span>
                            </div>

                            <div className="bg-slate-100 px-3 py-1 rounded-full text-xs">Unit {quizQuestion.unit} - L{quizQuestion.lesson}</div>
                          </div>
                          
                          {quizSubMode === 'choice' ? (
                              <>
                                  <h3 className="text-lg text-slate-400 mb-4">這個單字的意思是？</h3>
                                  <h2 className="text-5xl md:text-6xl font-bold text-slate-800 mb-6">{quizQuestion.en}</h2>
                                  <button 
                                    onClick={() => speak(quizQuestion.en)}
                                    className="inline-flex items-center gap-2 px-5 py-2 bg-indigo-50 text-indigo-600 hover:bg-indigo-100 rounded-full text-sm font-bold transition-colors"
                                  >
                                    <Icons.Volume2 className="w-4 h-4" /> 聽發音
                                  </button>
                              </>
                          ) : (
                              /* Spelling Mode Header */
                              <div className="flex flex-col items-center">
                                  <button 
                                    onClick={() => speak(quizQuestion.en)}
                                    className="w-24 h-24 bg-indigo-50 rounded-full flex items-center justify-center text-indigo-600 hover:bg-indigo-100 hover:scale-105 active:scale-95 transition-all mb-6"
                                  >
                                    <Icons.Volume2 className="w-12 h-12" />
                                  </button>
                                  <p className="text-slate-400 mb-2">點擊喇叭聽發音，並輸入單字</p>
                                  <p className="text-sm text-slate-300">({quizQuestion.zh})</p>
                              </div>
                          )}
                        </div>
                        )}

                        {/* Quiz Content Area */}
                        {quizSubMode === 'choice' ? (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                              {quizOptions.map((option) => {
                                let btnClass = "p-6 md:p-8 text-xl font-bold rounded-2xl border-2 transition-all transform hover:shadow-md text-left relative overflow-hidden ";
                                
                                if (showResult) {
                                  if (option.id === quizQuestion.id) btnClass += "bg-green-50 border-green-500 text-green-700 shadow-green-100";
                                  else if (option.id !== quizQuestion.id && lastAnswerCorrect === false) btnClass += "bg-slate-50 border-slate-100 text-slate-300 opacity-50"; 
                                  else btnClass += "bg-white border-slate-100 text-slate-400 opacity-50";
                                } else {
                                  btnClass += "bg-white border-slate-200 hover:border-indigo-500 hover:bg-indigo-50/50 text-slate-700 active:scale-[0.98]";
                                }

                                return (
                                  <button
                                    key={option.id}
                                    onClick={() => handleQuizAnswer(option)}
                                    disabled={showResult}
                                    className={btnClass}
                                  >
                                    <div className="flex items-center justify-between relative z-10">
                                      <span>{option.zh}</span>
                                      {showResult && option.id === quizQuestion.id && <Icons.CheckCircle className="w-8 h-8 text-green-600" />}
                                    </div>
                                  </button>
                                );
                              })}
                            </div>
                        ) : (
                            /* Spelling Mode Input Area */
                            <div className="w-full max-w-md mx-auto">
                                <form onSubmit={handleSpellingSubmit} className="relative">
                                    <input 
                                        ref={inputRef}
                                        type="text" 
                                        value={spellingInput}
                                        onChange={(e) => setSpellingInput(e.target.value)}
                                        placeholder="Type answer here..."
                                        className={`w-full p-4 text-2xl font-bold text-center rounded-2xl border-2 outline-none transition-all spelling-input ${
                                            showResult 
                                                ? (lastAnswerCorrect ? 'border-green-500 bg-green-50 text-green-800' : 'border-red-500 bg-red-50 text-red-800') 
                                                : 'border-slate-200 focus:border-indigo-500'
                                        }`}
                                        disabled={showResult}
                                        autoComplete="off"
                                        autoCorrect="off"
                                        autoCapitalize="off"
                                    />
                                    {!showResult && spellingInput && (
                                        <button type="submit" className="absolute right-2 top-2 bottom-2 bg-indigo-600 text-white px-4 rounded-xl font-bold hover:bg-indigo-700 transition-colors">
                                            Check
                                        </button>
                                    )}
                                </form>

                                {/* Actions below input */}
                                <div className="mt-4 flex justify-center gap-4">
                                    {!showResult && (
                                        <button 
                                            type="button"
                                            onClick={() => setShowSpellingAnswer(true)}
                                            className="text-slate-400 text-sm hover:text-indigo-600 flex items-center gap-1 transition-colors"
                                        >
                                            <Icons.HelpCircle className="w-4 h-4" /> 偷看答案
                                        </button>
                                    )}
                                </div>
                                
                                {/* Answer Reveal (Cheat or Result) */}
                                {(showSpellingAnswer || (showResult && !lastAnswerCorrect)) && (
                                    <div className="mt-4 text-center animate-bounce-in">
                                        <p className="text-slate-400 text-sm mb-1">Correct Answer:</p>
                                        <p className="text-2xl font-bold text-indigo-600 tracking-wider">{quizQuestion.en}</p>
                                    </div>
                                )}
                            </div>
                        )}

                        {showResult && (
                          <div className="mt-8 text-center animate-bounce-in">
                            <button 
                              onClick={handleNextQuestion}
                              autoFocus
                              className="w-full md:w-auto md:px-12 py-4 bg-indigo-600 text-white rounded-2xl font-bold text-lg shadow-xl hover:bg-indigo-700 hover:shadow-2xl hover:-translate-y-1 active:scale-95 transition-all flex items-center justify-center gap-3 mx-auto"
                            >
                              {quizIndex < quizList.length - 1 ? '下一題' : '完成測驗'} <Icons.ChevronRight className="w-6 h-6" />
                            </button>
                          </div>
                        )}
                      </>
                    )}
                  </div>
                )}

                {/* List Mode */}
                {activeTab === 'list' && (
                  <div className="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden mb-8">
                    <div className="p-6 bg-slate-50/50 border-b border-slate-100 flex flex-col md:flex-row justify-between items-center gap-4">
                      <h2 className="font-bold text-2xl text-slate-800">單字列表</h2>
                      <span className="text-sm font-medium bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full">
                        顯示 {filteredData.length} 個單字
                      </span>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 divide-y md:divide-y-0 md:gap-px bg-slate-100">
                      {filteredData.map((item, index) => (
                        <div key={item.id} className="bg-white p-5 flex items-center justify-between hover:bg-indigo-50/30 transition-colors group">
                          <div className="flex items-center gap-5">
                            <div className="flex flex-col items-center justify-center w-10 h-10 bg-slate-100 text-slate-400 rounded-lg font-mono text-sm group-hover:bg-indigo-100 group-hover:text-indigo-600 transition-colors">
                                {index + 1}
                            </div>
                            <div>
                               <div className="flex items-center gap-2 mb-1">
                                  <span className="text-xs font-bold text-slate-400 uppercase tracking-wider bg-slate-100 px-1.5 py-0.5 rounded">U{item.unit}</span>
                                  <span className="font-bold text-slate-800 text-lg group-hover:text-indigo-700 transition-colors">{item.en}</span>
                               </div>
                              <div className="flex items-center gap-2">
                                <span className="text-slate-500">{item.zh}</span>
                                <span className="text-xs bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full">{item.pos}</span>
                              </div>
                            </div>
                          </div>
                          <button 
                            onClick={() => speak(item.en)}
                            className="p-3 text-slate-300 hover:text-indigo-600 hover:bg-indigo-100 rounded-full transition-all opacity-0 group-hover:opacity-100 focus:opacity-100"
                            title="Play sound"
                          >
                            <Icons.Volume2 className="w-5 h-5" />
                          </button>
                        </div>
                      ))}
                    </div>
                     {filteredData.length === 0 && <div className="p-12 text-center text-slate-400">清單是空的</div>}
                  </div>
                )}

              </main>

              {/* Bottom Navigation - Mobile Only */}
              <nav className="md:hidden fixed bottom-0 w-full bg-white/90 backdrop-blur-md border-t border-slate-200 pb-safe z-30">
                <NavItems mobile={true} />
              </nav>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
